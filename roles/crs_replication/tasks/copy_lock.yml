---
## Log in to Cr Lab and generate a new token because the old token expires every 50-60 seconds.
- name: Get CRS API authentication token
  uri:
    validate_certs: no
    url: "https://{{CR_static_IP}}/cr/v5/login"
    method: POST
    headers:
      Content-Type: application/json
      Accept: application/json
    return_content: yes
    body:
      username: "{{username}}"
      password: "{{password}}"
    body_format: json 
  register: results_login
  tags:
    - lock

- debug:
    msg: "{{results_login}}"
  tags:
    - lock
  
## validating the copy status, whether locked or unlocked
- name: Get copy details
  uri:
    validate_certs: no
    force_basic_auth: yes
    url: https://{{CR_static_IP}}/cr/v5/policies/{{item.0}}/copies/{{item.1}}
    method: GET
    headers:
        Content-Type: application/json
        Accept: application/json
        X-CR-AUTH-TOKEN: "{{ results_login.json.accessToken}}"
    body_format: json
    status_code: 200
    return_content: yes
  register: copy_lock_before_details
  with_together:
    - "{{id}}"
    - "{{cid}}"
  tags:
    - lock


- name: printing copy id exist
  debug: 
    msg: "{{ copy_lock_before_details}}"
  tags:
    - lock
## Each copy checks the lock/unlock status and stores the result in the lock_status variable.
- set_fact:
    lock_status: "{{lock_status}} + [ '{{ item.json.lockStatus }}' ]"
  with_items: 
    - "{{ copy_lock_before_details.results}}"
  tags:
    - lock

- debug: 
    msg: "{{lock_status}}"
  tags:
    - lock

- name: Failing the playbook scince copy is already locked.
  fail:
    msg: Failing the playbook scince copy is already locked.
  when: item.json.lockStatus == "Locked"
  with_items: 
    - "{{ copy_lock_before_details.results}}"
  tags:
    - lock

- name: printing unlocked copy status
  debug: 
    msg: copy is {{lock_status }} ,we can  lock the copy.
  when: item.json.lockStatus == "Unlocked"
  with_items: 
    - "{{ copy_lock_before_details.results}}"
  tags:
    - lock
## 
- name: performing a copy lock action
  uri:
    validate_certs: no
    force_basic_auth: yes
    url: https://{{CR_static_IP}}/cr/v5/actions/lock
    method: POST
    headers:
        Content-Type: application/json
        Accept: application/json
        X-CR-AUTH-TOKEN: "{{ results_login.json.accessToken}}"
    body_format: json
    status_code: 200
    body:
      {
      "policyID": "{{item.0}}",
      "copyID": "{{item.1}}"
      } 
  register: results_Createlock
  with_together:
    - "{{id}}"
    - "{{cid}}"
  tags:
    - lock

